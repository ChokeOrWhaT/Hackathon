<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Disaster Management Community</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <!-- FontAwesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f3f4f6;
    }

    /* Navbar */
    .navbar {
      background: #1f2937;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      font-size: 1.1rem;
    }

    .navbar .logo {
      font-weight: 600;
    }

    .navbar .user {
      font-size: 0.9rem;
      color: #d1d5db;
    }

    /* Layout */
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    .sidebar h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: #374151;
    }

    .group {
      padding: 10px;
      margin-bottom: 8px;
      background: #f9fafb;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .group:hover {
      background: #e5e7eb;
    }

    .group i {
      margin-right: 8px;
      color: #2563eb;
    }

    .group.active {
      background: #dbeafe;
    }

    .delete-btn {
      border: none;
      background: none;
      color: #ef4444;
      font-size: 1rem;
      cursor: pointer;
    }

    .delete-btn:hover {
      color: #dc2626;
    }

    /* Chat section */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f9fafb;
    }

    .chat-header {
      background: #ffffff;
      padding: 12px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h2 {
      font-size: 1.1rem;
      color: #111827;
    }

    .chat-header span {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 14px;
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.4;
      font-size: 0.95rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message.user {
      background: #2563eb;
      color: white;
      margin-left: auto;
    }

    .message.other {
      background: #ffffff;
      color: #111827;
      margin-right: auto;
    }

    .chat-input {
      display: flex;
      padding: 12px;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .chat-input input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      outline: none;
    }

    .chat-input button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      margin-left: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    .chat-input button:hover {
      background: #1d4ed8;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo">üåç DisasterX Community</div>
    <div class="user">Welcome, Volunteer_123</div>
  </div>

  <!-- Layout -->
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Communities</h3>
      <div id="groups"></div>
      <button onclick="createGroup()"
        style="margin-top:auto; padding:8px; border:none; background:#2563eb; color:white; border-radius:8px; cursor:pointer;">‚ûï
        Create Group</button>
    </div>

    <!-- Chat Section -->
    <div class="chat">
      <div class="chat-header">
        <h2 id="chatTitle">Select a Community</h2>
        <span id="chatStats"></span>
      </div>
      <div class="messages" id="messages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDyL2xbz6shEdgd93w9LLu-xjiEilDONIA",
    authDomain: "family-identification-tool.firebaseapp.com",
    projectId: "family-identification-tool",
    storageBucket: "family-identification-tool.appspot.com",
    messagingSenderId: "482977845070",
    appId: "1:482977845070:web:5f5c66b3327a662cabd81f"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentGroup = "global"; // default chat room
  let unsubscribeMessages = null;
  const userId = "Volunteer_" + Math.floor(Math.random() * 1000);

  // Load groups
  function loadGroups() {
    const groupsDiv = document.getElementById("groups");
    groupsDiv.innerHTML = "";

    // Add Global Chat first
    const globalDiv = document.createElement("div");
    globalDiv.className = "group" + (currentGroup === "global" ? " active" : "");
    globalDiv.innerHTML = `<span><i class="fas fa-globe"></i> üåç Global Community</span>`;
    globalDiv.onclick = () => joinGroup("global", "üåç Global Community");
    groupsDiv.appendChild(globalDiv);

    // Load custom groups from Firestore
    db.collection("groups").onSnapshot(snapshot => {
      groupsDiv.querySelectorAll(".custom-group").forEach(e => e.remove()); // clear old

      snapshot.forEach(doc => {
        const group = doc.data();
        const div = document.createElement("div");
        div.className = "group custom-group" + (doc.id === currentGroup ? " active" : "");
        div.innerHTML = `
          <span style="flex:1;" onclick="joinGroup('${doc.id}', '${group.name}')">
            <i class="fas fa-users"></i> ${group.name}
          </span>
          <button class="delete-btn" onclick="deleteGroup('${doc.id}')">üóëÔ∏è</button>
        `;
        groupsDiv.appendChild(div);
      });
    });
  }

  function createGroup() {
    const name = prompt("Enter group name:");
    if (name) {
      db.collection("groups").add({
        name,
        createdBy: userId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }

  function joinGroup(groupId, groupName) {
    currentGroup = groupId;
    document.getElementById("chatTitle").innerText = groupName;
    document.getElementById("messages").innerHTML = "";

    if (unsubscribeMessages) unsubscribeMessages();

    let messagesRef;
    if (groupId === "global") {
      messagesRef = db.collection("globalMessages");
    } else {
      messagesRef = db.collection("groups").doc(groupId).collection("messages");
    }

    unsubscribeMessages = messagesRef.orderBy("timestamp", "asc")
      .onSnapshot(snapshot => {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        snapshot.forEach(doc => {
          const msg = doc.data();

          // Hide if user deleted for self
          if (msg.deletedFor && msg.deletedFor.includes(userId)) return;

          const div = document.createElement("div");
          div.className = "message " + (msg.user === userId ? "user" : "other");

          const time = msg.timestamp?.toDate
            ? msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            : "";

          div.innerHTML = `
            <div class="msg-bubble"
                 onclick="selectMessage('${groupId}','${doc.id}','${msg.text}','${msg.user}')">
              <strong>${msg.user}:</strong> ${msg.deleted ? `<i>${msg.text}</i>` : msg.text}
              <div style="font-size:0.75rem;color:#6b7280;">${time}</div>
            </div>
          `;
          messagesDiv.appendChild(div);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, err => {
        console.error("Snapshot error:", err);
      });
  }

  function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();

    if (!text) {
      alert("Type a message first!");
      return;
    }

    let messagesRef;
    if (currentGroup === "global") {
      messagesRef = db.collection("globalMessages");
    } else {
      messagesRef = db.collection("groups").doc(currentGroup).collection("messages");
    }

    messagesRef.add({
      text,
      user: userId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      deleted: false,
      deletedFor: []
    }).then(() => {
      console.log("Message stored successfully");
    }).catch(err => {
      console.error("Error sending message:", err);
    });

    input.value = "";
  }

  // üóëÔ∏è Delete group
  async function deleteGroup(groupId) {
    const confirmDelete = confirm("Are you sure you want to delete this group?");
    if (!confirmDelete) return;

    // delete subcollection messages
    const messagesRef = db.collection("groups").doc(groupId).collection("messages");
    const snapshot = await messagesRef.get();
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // delete group itself
    await db.collection("groups").doc(groupId).delete();

    if (currentGroup === groupId) {
      currentGroup = "global";
      joinGroup("global", "üåç Global Community");
    }
  }

  // üóëÔ∏è Delete message (for me / for everyone)
  function selectMessage(groupId, messageId, text, sender) {
    let options = [];

    if (sender === userId) {
      options = ["Delete for Me", "Delete for Everyone"];
    } else {
      options = ["Delete for Me"];
    }

    const choice = prompt(`Choose action:\n${options.join("\n")}`);
    if (!choice) return;

    let messagesRef = (groupId === "global")
      ? db.collection("globalMessages").doc(messageId)
      : db.collection("groups").doc(groupId).collection("messages").doc(messageId);

    if (choice === "Delete for Me") {
      messagesRef.update({
        deletedFor: firebase.firestore.FieldValue.arrayUnion(userId)
      });
    } else if (choice === "Delete for Everyone" && sender === userId) {
      messagesRef.update({
        text: "üö´ This message was deleted",
        deleted: true
      });
    }
  }

  // Init
  loadGroups();
  joinGroup("global", "üåç Global Community"); // default view
</script>


</body>

</html>